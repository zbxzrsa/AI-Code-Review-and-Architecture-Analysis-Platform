name: Secret Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better scanning

      - name: Setup Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_COMMIT_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Run Gitleaks Scan
        run: |
          gitleaks detect --config .gitleaks.toml --verbose --report-path gitleaks-report.json

      - name: Upload Gitleaks Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('gitleaks-report.json', 'utf8'));
              if (report && report.length > 0) {
                const comment = `## ðŸ” Secret Detection Results
                
                **Gitleaks found ${report.length} potential secrets:**
                
                ${report.map(finding => 
                  `- **${finding.ruleId}** in \`${finding.file}\` (line ${finding.startLine})
                    - Description: ${finding.description}
                    - Severity: ${finding.severity}`
                ).join('\n')}
                
                âš ï¸ **Please review and remove any secrets before merging.**
                
                ---
                *This comment was generated by the secret security scan.*`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              } else {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: '## âœ… Secret Detection Results\n\nNo secrets detected by Gitleaks scan.\n\n---\n*This comment was generated by the secret security scan.*'
                });
              }
            } catch (error) {
              console.log('No Gitleaks report found or error parsing:', error.message);
            }

  trufflehog-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --only-verified --debug

      - name: Upload TruffleHog Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json
          retention-days: 30

  detect-secrets-scan:
    name: Detect-Secrets Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets Scan
        run: |
          if [ -f .secrets.baseline ]; then
            detect-secrets scan --baseline .secrets.baseline --all-files --report-file detect-secrets-report.json
          else
            detect-secrets scan --all-files --report-file detect-secrets-report.json
          fi

      - name: Upload detect-secrets Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detect-secrets-report
          path: detect-secrets-report.json
          retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks-scan, trufflehog-scan, detect-secrets-scan]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
          pattern: '*-report'

      - name: Generate Summary
        if: github.event_name == 'pull_request'
        run: |
          echo "## ðŸ” Secret Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "reports/gitleaks-report/gitleaks-report.json" ]; then
            GITLEAKS_COUNT=$(jq length reports/gitleaks-report/gitleaks-report.json 2>/dev/null || echo "0")
            echo "### Gitleaks: $GITLEAKS_COUNT findings" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Gitleaks: âœ… No findings" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "reports/trufflehog-report/trufflehog-report.json" ]; then
            TRUFFLEHOG_COUNT=$(jq length reports/trufflehog-report/trufflehog-report.json 2>/dev/null || echo "0")
            echo "### TruffleHog: $TRUFFLEHOG_COUNT findings" >> $GITHUB_STEP_SUMMARY
          else
            echo "### TruffleHog: âœ… No findings" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "reports/detect-secrets-report/detect-secrets-report.json" ]; then
            DETECT_SECRETS_COUNT=$(jq '.results | length' reports/detect-secrets-report/detect-secrets-report.json 2>/dev/null || echo "0")
            echo "### Detect-Secrets: $DETECT_SECRETS_COUNT findings" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Detect-Secrets: âœ… No findings" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Total secret scans completed: 3/3**" >> $GITHUB_STEP_SUMMARY
